<!DOCTYPE html>
<html>
<head>
    <title>Assembled Furniture View</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        canvas { border: 2px solid #333; margin: 20px auto; display: block; background: white; }
        .info { text-align: center; margin: 10px; }
    </style>
</head>
<body>
    <h1>Assembled Furniture View (Top Down)</h1>
    <div class="info">This shows how your furniture will look when assembled - panel view from above</div>
    <input type="file" id="jsonFile" accept=".json">
    <canvas id="assembledView" width="600" height="800"></canvas>

    <script>
        document.getElementById('jsonFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        drawAssembledView(data);
                    } catch (error) {
                        alert('Error: Invalid JSON file');
                    }
                };
                reader.readAsText(file);
            }
        });

        function drawAssembledView(data) {
            const canvas = document.getElementById('assembledView');
            const ctx = canvas.getContext('2d');
            const scale = 1.8;
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Find the main panel (tampo)
            const panel = data.pieces.find(p => p.name.toLowerCase().includes('tampo'));
            const legs = data.pieces.filter(p => p.name.toLowerCase().includes('perna'));
            
            if (!panel) {
                ctx.fillStyle = '#ff0000';
                ctx.font = '16px Arial';
                ctx.fillText('No tampo piece found in JSON', 50, 50);
                return;
            }
            
            console.log('Found panel:', panel.name, 'with dimensions:', panel.length, 'x', panel.height, 'x', panel.thickness);
            
            // Center the drawing
            const offsetX = (canvas.width - panel.length * scale) / 2;
            const offsetY = 100;
            
            // Draw panel outline (top view)
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 3;
            ctx.strokeRect(offsetX, offsetY, panel.length * scale, panel.height * scale);
            
            // Add panel label
            ctx.fillStyle = '#000';
            ctx.font = '16px Arial';
            ctx.fillText('Table Top (Panel)', offsetX, offsetY - 10);
            
            // Get faces as arrays (they're stored as arrays, not objects)
            const panelMainFace = panel.faces.find(f => f.faceSide === 'main');
            const panelOtherMainFace = panel.faces.find(f => f.faceSide === 'other_main');
            const panelTopFace = panel.faces.find(f => f.faceSide === 'top');
            
            console.log('Found faces:', {
                main: !!panelMainFace,
                other_main: !!panelOtherMainFace, 
                top: !!panelTopFace
            });
            
            // Draw connection areas from BOTTOM face (where legs connect)
            const panelBottomFace = panel.faces.find(f => f.faceSide === 'bottom');
            if (panelBottomFace && panelBottomFace.connectionAreas && panelBottomFace.connectionAreas.length > 0) {
                console.log('Drawing', panelBottomFace.connectionAreas.length, 'connection areas from bottom face');
                panelBottomFace.connectionAreas.forEach((connArea, index) => {
                    // Connection areas on bottom face use length x height coordinates
                    const panelX = offsetX + connArea.x_min * scale;
                    const panelY = offsetY + connArea.y_min * scale;
                    const areaWidth = (connArea.x_max - connArea.x_min) * scale;
                    const areaHeight = (connArea.y_max - connArea.y_min) * scale;
                    
                    // Draw gray filled rectangle (like in your reference image)
                    ctx.fillStyle = `rgba(128, 128, 128, 0.6)`;
                    ctx.fillRect(panelX, panelY, areaWidth, areaHeight);
                    
                    // Add red border
                    ctx.strokeStyle = '#ff0000';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(panelX, panelY, areaWidth, areaHeight);
                    
                    // Add connection area label
                    ctx.fillStyle = '#000';
                    ctx.font = 'bold 10px Arial';
                    ctx.fillText(`Conn ${connArea.connectionId || index + 1}`, panelX + 2, panelY + 12);
                });
            }
            
            // Draw holes from bottom face that have connectionId (these are positioned inside connection areas by app.py)
            let holeIndex = 0;
            const labels = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
            
            if (panelBottomFace && panelBottomFace.holes) {
                // Get holes that have connectionId (these are the ones connected to legs)
                const connectedHoles = panelBottomFace.holes.filter(hole => hole.connectionId);
                console.log(`Drawing ${connectedHoles.length} connected holes from bottom face`);
                
                connectedHoles.forEach((hole) => {
                    // Use the hole's actual coordinates (now positioned correctly by app.py inside connection areas)
                    const holeX = offsetX + hole.x * scale;
                    const holeY = offsetY + hole.y * scale;
                    
                    // Draw hole circle
                    ctx.beginPath();
                    ctx.arc(holeX, holeY, 6, 0, 2 * Math.PI);
                    ctx.fillStyle = '#000';
                    ctx.fill();
                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 1;
                    ctx.stroke();
                    
                    // Add hole label
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 10px Arial';
                    const label = labels[holeIndex % labels.length];
                    ctx.fillText(label, holeX - 3, holeY + 3);
                    holeIndex++;
                });
            }
            
            // Add reference crosses at corners
            const crossSize = 10;
            [
                [offsetX - 20, offsetY - 20],
                [offsetX + panel.length * scale + 10, offsetY - 20],
                [offsetX - 20, offsetY + panel.height * scale + 10],
                [offsetX + panel.length * scale + 10, offsetY + panel.height * scale + 10]
            ].forEach(([x, y]) => {
                ctx.strokeStyle = '#666';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(x - crossSize, y);
                ctx.lineTo(x + crossSize, y);
                ctx.moveTo(x, y - crossSize);
                ctx.lineTo(x, y + crossSize);
                ctx.stroke();
            });
            
            // Add dimensions
            ctx.fillStyle = '#666';
            ctx.font = '12px Arial';
            ctx.fillText(`${panel.length}mm`, offsetX + panel.length * scale / 2 - 20, offsetY + panel.height * scale + 30);
            ctx.fillText(`${panel.height}mm`, offsetX - 50, offsetY + panel.height * scale / 2);
            
            // Add info about what was found
            ctx.fillStyle = '#333';
            ctx.font = '12px Arial';
            let infoY = 20;
            ctx.fillText(`Panel: ${panel.name} (${panel.length}×${panel.height}×${panel.thickness}mm)`, 20, infoY);
            infoY += 20;
            
            const connectedHoles = panelBottomFace?.holes?.filter(hole => hole.connectionId) || [];
            const totalConnAreas = panelBottomFace?.connectionAreas?.length || 0;
            ctx.fillText(`Connected Holes: ${connectedHoles.length}, Connection Areas: ${totalConnAreas}`, 20, infoY);
        }
    </script>
</body>
</html> 